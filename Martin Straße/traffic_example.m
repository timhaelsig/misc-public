close all
clear all


%% Load wav file

[y,Fs] = audioread('traffic.wav');

y = y*1;   % initial level


figure
pwelch(y, 5e3, [], [], Fs, 'centered');

power_init = 10*log10(var(y,0,1))


%% Power reduction over complete band

y_6dB = sqrt(10^(-6/10))*y;
y_12dB = sqrt(10^(-12/10))*y;

power_6 = 10*log10(var(y_6dB,0,1))
power_12 = 10*log10(var(y_12dB,0,1))


y_36dB = sqrt(10^(-36/10))*y;
y_39dB = sqrt(10^(-39/10))*y;
y_42dB = sqrt(10^(-42/10))*y;


% sound(y,Fs)
% pause(5)
% clear sound
% 
% sound(y_36dB,Fs)
% pause(5)
% clear sound
% 
% sound(y_39dB,Fs)
% pause(5)
% clear sound
% 
% sound(y_42dB,Fs)
% pause(5)
% clear sound


audiowrite('normal.wav',y,Fs);
audiowrite('normal_6dB.wav',y_6dB,Fs);
audiowrite('normal_12dB.wav',y_12dB,Fs);

audiowrite('normal_36dB.wav',y_36dB,Fs);
audiowrite('normal_39dB.wav',y_39dB,Fs);
audiowrite('normal_42dB.wav',y_42dB,Fs);


%% Filtering

% filter_normal = [0.00444825054626407,0.00359161341452960,0.00493228155196806,0.00650800669773462,0.00831449059953586,0.0103418958890823,0.0125686753762934,0.0149697704166710,0.0175052982802571,0.0201385471794156,0.0228121806570185,0.0254772499039484,0.0280751098679243,0.0305424691257195,0.0328264560545567,0.0348692054571104,0.0366176514385103,0.0380258620760606,0.0390602066746696,0.0396927801509947,0.0399050989191944,0.0396927801509947,0.0390602066746696,0.0380258620760606,0.0366176514385103,0.0348692054571104,0.0328264560545567,0.0305424691257195,0.0280751098679243,0.0254772499039484,0.0228121806570185,0.0201385471794156,0.0175052982802571,0.0149697704166710,0.0125686753762934,0.0103418958890823,0.00831449059953586,0.00650800669773462,0.00493228155196806,0.00359161341452960,0.00444825054626407];
filter_normal = [0.00325665209987432,0.00178254042476531,0.00224750851201955,0.00277294743485751,0.00336255511725180,0.00401546072090265,0.00473204483054145,0.00551134878973280,0.00635069898071215,0.00724706746857225,0.00819588149591945,0.00919326184738382,0.0102332202940681,0.0113094222606216,0.0124137010982062,0.0135379351000295,0.0146730091109637,0.0158095214993781,0.0169377858939768,0.0180477042372634,0.0191291899013869,0.0201709748086721,0.0211627932887026,0.0220943605430263,0.0229574932417283,0.0237427776702055,0.0244417035232757,0.0250456389917033,0.0255490285412205,0.0259478802912450,0.0262345470926998,0.0264095304473815,0.0264641618189146,0.0264095304473815,0.0262345470926998,0.0259478802912450,0.0255490285412205,0.0250456389917033,0.0244417035232757,0.0237427776702055,0.0229574932417283,0.0220943605430263,0.0211627932887026,0.0201709748086721,0.0191291899013869,0.0180477042372634,0.0169377858939768,0.0158095214993781,0.0146730091109637,0.0135379351000295,0.0124137010982062,0.0113094222606216,0.0102332202940681,0.00919326184738382,0.00819588149591945,0.00724706746857225,0.00635069898071215,0.00551134878973280,0.00473204483054145,0.00401546072090265,0.00336255511725180,0.00277294743485751,0.00224750851201955,0.00178254042476531,0.00325665209987432];

filter_3dB = sqrt(10^(-3/10)) * filter_normal;
filter_6dB = sqrt(10^(-6/10)) * filter_normal;

% fvtool(filter_normal)
% fvtool(filter_6dB)
% fvtool(filter_12dB)


10*log10(sum(abs(filter_normal).^2))
10*log10(sum(abs(filter_3dB).^2))
10*log10(sum(abs(filter_6dB).^2))

y_filt_36dB = upfirdn(y, filter_normal);
y_filt_39dB = upfirdn(y, filter_3dB);
y_filt_42dB = upfirdn(y, filter_6dB);


% sound(y_filt_36dB,Fs)
% pause(5)
% clear sound
% 
% sound(y_filt_39dB,Fs)
% pause(5)
% clear sound
% 
% sound(y_filt_42dB,Fs)
% pause(5)
% clear sound

power_filt = 10*log10(var(y_filt_36dB,0,1))
power_filt6 = 10*log10(var(y_filt_39dB,0,1))
power_filt12 = 10*log10(var(y_filt_42dB,0,1))

audiowrite('filt_36dB.wav',y_filt_36dB,Fs);
audiowrite('filt_39dB.wav',y_filt_39dB,Fs);
audiowrite('filt_42dB.wav',y_filt_42dB,Fs);

figure
pwelch([y_filt_36dB y_filt_42dB], 5e3, [], [], Fs, 'centered');

